wp.textWidgets=function(t){"use strict";var e={dismissedPointers:[]};return e.TextWidgetControl=Backbone.View.extend({events:{},initialize:function(e){var i=this;if(!e.el)throw new Error("Missing options.el");if(!e.syncContainer)throw new Error("Missing options.syncContainer");Backbone.View.prototype.initialize.call(i,e),i.syncContainer=e.syncContainer,i.$el.addClass("text-widget-fields"),i.$el.html(wp.template("widget-text-control-fields")),i.customHtmlWidgetPointer=i.$el.find(".wp-pointer.custom-html-widget-pointer"),i.customHtmlWidgetPointer.length&&(i.customHtmlWidgetPointer.find(".close").on("click",function(e){e.preventDefault(),i.customHtmlWidgetPointer.hide(),t("#"+i.fields.text.attr("id")+"-html").focus(),i.dismissPointers(["text_widget_custom_html"])}),i.customHtmlWidgetPointer.find(".add-widget").on("click",function(t){t.preventDefault(),i.customHtmlWidgetPointer.hide(),i.openAvailableWidgetsPanel()})),i.pasteHtmlPointer=i.$el.find(".wp-pointer.paste-html-pointer"),i.pasteHtmlPointer.length&&i.pasteHtmlPointer.find(".close").on("click",function(t){t.preventDefault(),i.pasteHtmlPointer.hide(),i.editor.focus(),i.dismissPointers(["text_widget_custom_html","text_widget_paste_html"])}),i.fields={title:i.$el.find(".title"),text:i.$el.find(".text")},_.each(i.fields,function(t,e){t.on("input change",function(){var n=i.syncContainer.find("input[type=hidden]."+e);n.val()!==t.val()&&(n.val(t.val()),n.trigger("change"))}),t.val(i.syncContainer.find("input[type=hidden]."+e).val())})},dismissPointers:function(t){_.each(t,function(t){wp.ajax.post("dismiss-wp-pointer",{pointer:t}),e.dismissedPointers.push(t)})},openAvailableWidgetsPanel:function(){var t;wp.customize.section.each(function(e){e.extended(wp.customize.Widgets.SidebarSection)&&e.expanded()&&(t=wp.customize.control("sidebars_widgets["+e.params.sidebarId+"]"))}),t&&setTimeout(function(){wp.customize.Widgets.availableWidgetsPanel.open(t),wp.customize.Widgets.availableWidgetsPanel.$search.val("HTML").trigger("keyup")})},updateFields:function(){var t,e=this;e.fields.title.is(document.activeElement)||(t=e.syncContainer.find("input[type=hidden].title"),e.fields.title.val(t.val())),t=e.syncContainer.find("input[type=hidden].text"),e.fields.text.is(":visible")?e.fields.text.is(document.activeElement)||e.fields.text.val(t.val()):e.editor&&!e.editorFocused&&t.val()!==e.fields.text.val()&&e.editor.setContent(wp.editor.autop(t.val()))},initializeEditor:function(){function i(){var d,r,u;if(document.getElementById(n)){if(void 0===window.tinymce)return void wp.editor.initialize(n,{quicktags:!0});if(tinymce.get(n)&&(l=tinymce.get(n).isHidden(),wp.editor.remove(n)),wp.editor.initialize(n,{tinymce:{wpautop:!0},quicktags:!0}),u=function(e){e.show(),e.find(".close").focus(),wp.a11y.speak(e.find("h3, p").map(function(){return t(this).text()}).get().join("\n\n"))},!(d=window.tinymce.get(n)))throw new Error("Failed to initialize editor");r=function(){t(d.getWin()).on("unload",function(){_.defer(i)}),l&&switchEditors.go(n,"html"),t("#"+n+"-html").on("click",function(){s.pasteHtmlPointer.hide(),-1===e.dismissedPointers.indexOf("text_widget_custom_html")&&u(s.customHtmlWidgetPointer)}),t("#"+n+"-tmce").on("click",function(){s.customHtmlWidgetPointer.hide()}),d.on("pastepreprocess",function(t){var i=t.content;-1===e.dismissedPointers.indexOf("text_widget_paste_html")&&i&&/&lt;\w+.*?&gt;/.test(i)&&_.delay(function(){u(s.pasteHtmlPointer)},250)})},d.initialized?r():d.on("init",r),s.editorFocused=!1,d.on("focus",function(){s.editorFocused=!0}),d.on("paste",function(){d.setDirty(!0),o()}),d.on("NodeChange",function(){c=!0}),d.on("NodeChange",_.debounce(o,a)),d.on("blur hide",function(){s.editorFocused=!1,o()}),s.editor=d}}var n,d,o,s=this,a=1e3,l=!1,c=!1;d=s.fields.text,n=d.attr("id"),o=function(){s.editor.isDirty()&&(wp.customize&&wp.customize.state&&(wp.customize.state("processing").set(wp.customize.state("processing").get()+1),_.delay(function(){wp.customize.state("processing").set(wp.customize.state("processing").get()-1)},300)),s.editor.isHidden()||s.editor.save()),c&&(d.trigger("change"),c=!1)},s.syncContainer.closest(".widget").find("[name=savewidget]:first").on("click",function(){o()}),i()}}),e.widgetControls={},e.handleWidgetAdded=function(i,n){var d,o,s,a,l,c,r,u;d=n.find("> .widget-inside > .form, > .widget-inside > form"),"text"===(o=d.find("> .id_base").val())&&(a=d.find(".widget-id").val(),e.widgetControls[a]||d.find(".visual").val()&&(r=t("<div></div>"),u=n.find(".widget-content:first"),u.before(r),s=new e.TextWidgetControl({el:r,syncContainer:u}),e.widgetControls[a]=s,l=n.parent(),(c=function(){l.is(":animated")?setTimeout(c,50):s.initializeEditor()})()))},e.setupAccessibleMode=function(){var i,n,d,o,s;i=t(".editwidget > form"),0!==i.length&&"text"===(n=i.find("> .widget-control-actions > .id_base").val())&&i.find(".visual").val()&&(o=t("<div></div>"),s=i.find("> .widget-inside"),s.before(o),d=new e.TextWidgetControl({el:o,syncContainer:s}),d.initializeEditor())},e.handleWidgetUpdated=function(t,i){var n,d,o,s;n=i.find("> .widget-inside > .form, > .widget-inside > form"),"text"===(s=n.find("> .id_base").val())&&(d=n.find("> .widget-id").val(),(o=e.widgetControls[d])&&o.updateFields())},e.init=function(){var i=t(document);i.on("widget-added",e.handleWidgetAdded),i.on("widget-synced widget-updated",e.handleWidgetUpdated),t(function(){var i;"widgets"===window.pagenow&&(i=t(".widgets-holder-wrap:not(#available-widgets)").find("div.widget"),i.one("click.toggle-widget-expanded",function(){var i=t(this);e.handleWidgetAdded(new jQuery.Event("widget-added"),i)}),t(window).on("load",function(){e.setupAccessibleMode()}))})},e}(jQuery);